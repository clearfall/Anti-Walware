function WG($t){Write-Host $t -ForegroundColor Green}
function WY($t){Write-Host $t -ForegroundColor Yellow}
function WR($t){Write-Host $t -ForegroundColor Red}
if(-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)){WR "Run PowerShell as Administrator";exit 1}
$steps=@("Init","UpdateSignatures","DetectAV","ListExclusions","QuickScan","CollectDetections","FullScan","Heuristics","Autoruns","BrowserExt","Report","CleanupOffer","Finalize")
$total=$steps.Count
$stepIndex=0
function Set-Progress($name,$pct){$global:stepIndex++;Write-Progress -Activity "Malware Check" -Status "$name" -PercentComplete $pct -Id 1}
Set-Progress "Init" ([math]::Round(($stepIndex+1)/$total*100))
try{Set-Progress "UpdateSignatures" ([math]::Round(($stepIndex+1)/$total*100));Update-MpSignature -ErrorAction Stop}catch{try{& (Join-Path $env:ProgramFiles "Windows Defender\MpCmdRun.exe") -SignatureUpdate | Out-Null}catch{}}
Set-Progress "DetectAV" ([math]::Round(($stepIndex+1)/$total*100))
$avProducts=@()
try{$avProducts=Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntiVirusProduct -ErrorAction Stop | Select-Object displayName,productState,pathToSignedProductExe}catch{$avProducts=@()}
Set-Progress "ListExclusions" ([math]::Round(($stepIndex+1)/$total*100))
$mpPrefs=$null
try{$mpPrefs=Get-MpPreference -ErrorAction Stop}catch{$mpPrefs=$null}
Set-Progress "QuickScan" ([math]::Round(($stepIndex+1)/$total*100))
try{Start-MpScan -ScanType QuickScan -ErrorAction SilentlyContinue | Out-Null}catch{}
Start-Sleep -Seconds 3
Set-Progress "CollectDetections" ([math]::Round(($stepIndex+1)/$total*100))
$detections=@()
try{$detections=Get-MpThreatDetection -ErrorAction SilentlyContinue}catch{$detections=@()}
Set-Progress "FullScan" ([math]::Round(($stepIndex+1)/$total*100))
try{Start-MpScan -ScanType FullScan -AsJob -ErrorAction SilentlyContinue | Out-Null}catch{}
$pollLimit=30
for($i=0;$i -lt $pollLimit;$i++){Start-Sleep -Seconds 10;try{$new=Get-MpThreatDetection -ErrorAction SilentlyContinue;if($new){$detections=($detections+$new)|Select-Object -Unique}}catch{};Set-Progress ("FullScan Polling {0}/{1}" -f ($i+1),$pollLimit) ([math]::Round((($stepIndex + ($i/$pollLimit))/ $total)*100))}
Set-Progress "Heuristics" ([math]::Round(($stepIndex+1)/$total*100))
$procSuspicious=@()
Get-Process | ForEach-Object {
 try{
  $p=$_; $path=($p|Get-Process -ErrorAction SilentlyContinue).Path
  if($path){$sig=Get-AuthenticodeSignature -FilePath $path -ErrorAction SilentlyContinue; if(($sig -and $sig.Status -eq 'NotSigned') -or -not $sig){$procSuspicious+=[PSCustomObject]@{ProcessName=$p.ProcessName;Id=$p.Id;Path=$path;Signature=if($sig){$sig.Status}else{"NoSig"}}}}
 }catch{}
}
Set-Progress "Autoruns" ([math]::Round(($stepIndex+1)/$total*100))
$runKeys=@("HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run","HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run","HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run")
$autoruns=@()
foreach($k in $runKeys){try{$vals=Get-ItemProperty -Path $k -ErrorAction SilentlyContinue;if($vals){$vals.PSObject.Properties|Where-Object{$_.Name -notin @("PSPath","PSParentPath","PSChildName","PSDrive")}|ForEach-Object{$autoruns+=[PSCustomObject]@{Key=$k;Name=$_.Name;Value=$_.Value}}}}catch{}}
Set-Progress "BrowserExt" ([math]::Round(($stepIndex+1)/$total*100))
function ListExt($base){if(Test-Path $base){Get-ChildItem -Path $base -Directory -ErrorAction SilentlyContinue|ForEach-Object {[PSCustomObject]@{Id=$_.Name;Versions=(Get-ChildItem -Path $_.FullName -Directory -ErrorAction SilentlyContinue|Select-Object -ExpandProperty Name -ErrorAction SilentlyContinue) -join ","}}}else{@()}}
$chromeExtPath="$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Extensions"
$edgeExtPath="$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Extensions"
$chromeExts=ListExt $chromeExtPath
$edgeExts=ListExt $edgeExtPath
Set-Progress "Report" ([math]::Round(($stepIndex+1)/$total*100))
if($avProducts.Count -gt 0){WY "`nDetected Antivirus products:"; $avProducts|ForEach-Object{Write-Host "- $($_.displayName) `tExe: $($_.pathToSignedProductExe)"} }else{WY "No antivirus products detected"}
if($mpPrefs){WY "`nDefender Exclusions - Paths:";if($mpPrefs.ExclusionPath){$mpPrefs.ExclusionPath|ForEach-Object{Write-Host " - $_"}}else{Write-Host " - (none)"};WY "Extensions:";if($mpPrefs.ExclusionExtension){$mpPrefs.ExclusionExtension|ForEach-Object{Write-Host " - $_"}}else{Write-Host " - (none)"};WY "Processes:";if($mpPrefs.ExclusionProcess){$mpPrefs.ExclusionProcess|ForEach-Object{Write-Host " - $_"}}else{Write-Host " - (none)"} }else{WY "Defender preferences not available"}
if($detections -and $detections.Count -gt 0){$unique=$detections|Select-Object ThreatID,ThreatName,ResourcesDetected,ActionSuccess -Unique; foreach($u in $unique){WG "`nMalware found : $($u.ThreatName)";Write-Host "  Resources detected: $($u.ResourcesDetected -join ', ')";Write-Host "  Remediation succeeded: $($u.ActionSuccess)"}}else{Write-Host "`nNo Defender detections found"}
if($procSuspicious.Count -gt 0){WG "`nMalware found : Potential unsigned processes or suspicious autoruns (heuristic)"; $procSuspicious|Select-Object -First 50|Format-Table -AutoSize}
WY "`nStartup/Autoruns:"; if($autoruns.Count -gt 0){$autoruns|ForEach-Object{Write-Host " - $($_.Key) -> $($_.Name) : $($_.Value)"}}else{Write-Host " - (none found)"}
WY "`nChrome Extensions:"; if($chromeExts.Count -gt 0){$chromeExts|ForEach-Object{Write-Host " - ID: $($_.Id) Versions: $($_.Versions)"}}else{Write-Host " - (none)"}
WY "`nEdge Extensions:"; if($edgeExts.Count -gt 0){$edgeExts|ForEach-Object{Write-Host " - ID: $($_.Id) Versions: $($_.Versions)"}}else{Write-Host " - (none)"}
function Ask($p){while($true){$a=Read-Host "$p (yes/no)";switch($a.ToLower()){"y"{$true} "yes"{$true} "n"{$false} "no"{$false} default{Write-Host "Please answer yes or no."}}}}
Set-Progress "CleanupOffer" ([math]::Round(($stepIndex+1)/$total*100))
$haveDetections=($detections -and $detections.Count -gt 0)
if($haveDetections){$want=Ask "Would you like to attempt automatic cleanup of Defender-detected items now?"}else{$want=Ask "No Defender detections found. Run Full Defender scan with remediation now?"}
if($want){WY "Attempting remediation";try{Start-MpScan -ScanType FullScan -ErrorAction Stop;Start-Sleep -Seconds 10}catch{WR "Remediation scan failed"};try{$post=Get-MpThreatDetection -ErrorAction SilentlyContinue;if($post -and $post.Count -gt 0){$post|ForEach-Object{WG "Malware found : $($_.ThreatName) (Resource(s): $($_.ResourcesDetected -join ', '))"}}else{Write-Host "No threats reported after remediation attempt"}}catch{};if($detections -and $detections.Count -gt 0){$allPaths=$detections|ForEach-Object{$_.ResourcesDetected}|Where-Object{$_}|Select-Object -Unique; if($allPaths.Count -gt 0){Write-Host "`nDetected items with file paths:"; $allPaths|ForEach-Object{Write-Host " - $_"}; if(Ask "Attempt to delete the above files now?"){foreach($p in $allPaths){try{if(Test-Path $p){$backup=Join-Path $env:TEMP ("malware-removed-$((Get-Date).ToString('yyyyMMdd-HHmmss'))");if(-not(Test-Path $backup)){New-Item -Path $backup -ItemType Directory|Out-Null};$dest=Join-Path $backup ([IO.Path]::GetFileName($p));Move-Item -Path $p -Destination $dest -Force -ErrorAction Stop;Write-Host "Moved $p -> $dest"}else{WY "Path not found: $p"}}catch{WR "Failed to remove $p : $($_.Exception.Message)"}}}else{Write-Host "Skipping manual deletes."}}}
else{Write-Host "Skipping cleanup as requested."}
Set-Progress "Finalize" 100
Write-Host "`nScan complete. To save a log run Start-Transcript before executing this script."
